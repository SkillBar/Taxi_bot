# Фундаментальный разбор: «Нет связи с сервером» в Mini App

**Проблема:** При открытии Mini App из Telegram на экране «Повторить» запрос GET /api/agents/me не доходит до сервера или ответ не возвращается клиенту. VITE_API_URL задан верно (https://taxi-botapi.vercel.app), /health в браузере отвечает.

---

## 1. Цепочка запроса (как тимлиды)

```
[Mini App в Telegram WebView]
    → fetch("https://taxi-botapi.vercel.app/api/agents/me", { headers: { "X-Telegram-Init-Data": "..." } })
    → Браузер: preflight OPTIONS (если cross-origin)
    → Сеть (мобильный интернет / Wi‑Fi)
    → Vercel Edge → Serverless Function (api/api/index.js)
    → Fastify: CORS → маршрут GET /api/agents/me
    → Ответ 200/401 → клиенту
```

**Сбой возможен на любом шаге.** Задача — понять, на каком.

---

## 2. Гипотезы (приоритет)

| # | Гипотеза | Почему вероятно | Как проверить |
|---|----------|------------------|----------------|
| **H1** | **CORS:** preflight OPTIONS не получает нужные заголовки или браузер блокирует ответ GET | Mini App открыт с origin A (например https://твой-webapp.vercel.app), запрос идёт на origin B (taxi-botapi.vercel.app). Без Access-Control-Allow-Origin и т.д. браузер не отдаёт ответ JS. | 1) В логах Vercel (API) смотреть: есть ли запросы OPTIONS и GET при нажатии «Повторить». 2) Вызвать GET https://taxi-botapi.vercel.app/ping из того же контекста (Mini App) и посмотреть ответ или ошибку в консоли. |
| **H2** | **Origin в WebView:** Telegram передаёт нестандартный Origin (null, или другой домен), и CORS его не пропускает | В iframe/WebView origin может отличаться от «обычного» браузера. | В ответе /ping смотреть, какой origin пришёл. В API явно разрешить известные значения (web.telegram.org и домен WebApp). |
| **H3** | **Запрос не доходит до Vercel:** блокировка на устройстве/операторе, DNS, фаервол | С телефона/сети пользователя taxi-botapi.vercel.app может быть недоступен. | С того же телефона открыть в обычном браузере https://taxi-botapi.vercel.app/health. Если не открывается — сетевая проблема. |
| **H4** | **Таймаут / холодный старт:** функция Vercel долго стартует, клиент уже отменил запрос (20 сек) | Serverless cold start + app.ready() могут давать задержку. | В логах Vercel смотреть Duration вызова. Если запросов нет — таймаут не причина (запрос не долетел). |
| **H5** | **Маршрутизация Vercel:** rewrite (.*) → /api/index не передаёт путь, Fastify получает не тот URL | Тогда наш handler не видит /api/agents/me. | В логах или в ответе /ping вывести req.url; убедиться, что до Fastify доходит именно /api/agents/me. |

---

## 3. Диагностический план (по шагам)

### Шаг 1: Есть ли запрос в Vercel вообще

- Vercel → проект **API** (taxi-botapi) → **Logs** (или **Functions** → логи).
- Открыть Mini App, нажать «Повторить», подождать до 20 сек.
- **Если в логах нет ни OPTIONS, ни GET** → запрос не доходит до Vercel (H1 preflight блокируется, или H3 сеть).  
- **Если есть OPTIONS и/или GET** → запрос доходит; смотреть статус и тело ответа (H2/H4/H5).

### Шаг 2: Проверка с того же устройства

- На **том же телефоне**, где открыт Telegram, в обычном браузере (Chrome/Safari) открыть:
  - https://taxi-botapi.vercel.app/health  
  - https://taxi-botapi.vercel.app/ping  
- Если не открываются — сетевая проблема (H3). Если открываются — сеть до API есть, фокус на CORS/Origin (H1, H2).

### Шаг 3: Что видит API (origin, путь)

- Вызвать **GET /ping** (без авторизации). В ответе должны быть `origin` и, при необходимости, `url`.
- Если из Mini App запрос до /ping **доходит** — CORS для простого GET работает; тогда проблема может быть в заголовках для /api/agents/me (например, x-telegram-init-data в preflight).  
- Если до /ping **не доходит** (та же «нет связи») — блокировка на этапе CORS preflight или сети.

### Шаг 4: Явный CORS под Mini App

- В API задать **WEBAPP_ORIGIN** = точный URL Mini App (как в BotFather), например:  
  `https://твой-webapp.vercel.app`  
- Добавить в разрешённые origin при необходимости:  
  `https://web.telegram.org`  
- Передеплоить API и повторить проверку из Mini App.

---

## 4. Что сделано в коде

- **GET /ping** — диагностический эндпоинт: 200 + JSON `{ ok, origin, url }`. Без авторизации. Нужен, чтобы проверить доходимость и какой Origin приходит.
- **CORS:** разрешены все методы и заголовки (Content-Type, x-telegram-init-data, X-Api-Secret). Origin: любой (или из WEBAPP_ORIGIN). Preflight обрабатывается @fastify/cors.
- **Таймаут 20 сек** на клиенте — чтобы не «висеть» вечно; после таймаута снова показывается экран ошибки.

---

## 5. Резюме для тимлида

- **Клиент:** URL API верный, запрос уходит (fetch с таймаутом). Либо приходит ответ, либо ошибка/таймаут.
- **Сервер:** /health и (после деплоя) /ping отвечают при прямом обращении.
- **Разрыв:** между браузером в WebView и нашим API. Наиболее вероятны:
  1. **CORS** (preflight или ответ без нужных заголовков).
  2. **Сеть** (до API с телефона не доходим).
- **Действия:** логи Vercel при «Повторить»; проверка /health и /ping с телефона; при необходимости явно прописать WEBAPP_ORIGIN и передеплоить API.
