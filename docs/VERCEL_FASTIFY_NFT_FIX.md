# Ошибка Vercel: "Unhandled type: BinaryExpression process.env.PORT ?? \"3001\""

Ошибка возникает при трассировке зависимостей **@vercel/nft**: парсер не понимает оператор `??` в **node_modules** (чаще всего Fastify 4.x). Ваш код уже без `??` — проблема в зависимостях, кэше или версии Node/build image.

Актуально на **февраль 2026**.

**В этом проекте внедрено:** postinstall-скрипт `api/scripts/patch-fastify-nullish.cjs` заменяет `??` на `||` в Fastify (server.js, route.js, error-handler.js) после каждого `npm install` / `npm ci`, чтобы nft не падал на node_modules. На Vercel postinstall выполняется в build phase до трассировки.

---

## Решения (по убыванию эффективности)

### 1. Node.js 20/22 в Vercel + Clear cache and redeploy

**Ожидаемый успех:** ~75–85% в подобных кейсах.

**Почему:** В 2026 дефолт Vercel — Node 20+, но старые проекты, клоны и монорепо без явного Root Directory могут тянуть старый образ сборки и старый nft. Явная версия Node + чистый кэш заставляют использовать актуальный трассировщик с поддержкой `??`.

**Шаги:**

1. **Vercel Dashboard** → выберите **проект API** (если API — отдельный проект) или проект монорепо.
2. **Settings** → **General**.
   - **Node.js Version** → выберите **20.x** (или **22.x**). В 2026 это чаще всего выпадающий список: `20.x`, `22.x`. Если поля нет — см. п. 4.
   - **Root Directory**: если деплоите только API из подпапки — укажите `api` (без слэша в конце). Оставьте пустым, если билд идёт из корня и сам заходит в `api/`.
3. **Settings** → **Build & Development Settings** (при необходимости):
   - Убедитесь, что **Override** не переопределяет команды так, что билд идёт не из той папки. Для API в подпапке обычно: Root Directory = `api`, Install = `npm ci` или `npm install`, Build = `npm run build`.
   - В части проектов **Node.js Version** дублируется здесь — выставите 20.x и тут.
4. **Deployments** → последний деплой → **⋯** → **Redeploy** → включите **Clear build cache and redeploy** → **Redeploy**.

**Подводные камни:**

- В монорепо при Root Directory = `api` все пути (Install/Build/Output) считаются относительно `api/`. Не ставьте Root = корень, если хотите билд именно из `api/`.
- После смены Node версии первый билд может быть дольше (нет кэша).

---

### 2. Явный runtime в vercel.json (фиксация Node для функций)

**Ожидаемый успех:** ~60–70% (часто срабатывает вместе с п.1).

**Почему:** `functions[].runtime` задаёт среду выполнения **serverless-функции**. Это может перебить дефолт и заставить использовать Node 20/22 при трассировке и рантайме.

**Файл:** `api/vercel.json` (в корне папки API, т.е. там же, где `api/index.js`).

**Шаги:**

1. Добавить/обновить блок `functions` так, чтобы ключ совпадал с путём к точке входа относительно **корня проекта Vercel**. Если Root Directory = `api`, то точка входа — `index.js` (относительно `api/`), т.е. в конфиге часто пишут `index.js`. Если Root = корень репо — путь может быть `api/index.js`.
2. Указать `runtime`: `nodejs20.x` или `nodejs22.x`.

Пример см. в разделе «Обновлённый vercel.json» ниже.

**Подводные камни:**

- Ключ в `functions` должен соответствовать тому, как Vercel видит файл (с учётом Root Directory). Неверный ключ — настройка игнорируется.
- Устаревшая документация может показывать `nodejs18.x` — в 2026 предпочтительно 20/22.

---

### 3. Новый Vercel-проект (тот же репо, без кэша)

**Ожидаемый успех:** ~70–80%.

**Почему:** Новый проект = новый кэш и актуальные дефолты (Node, build image, nft). Старый проект мог «залипнуть» на старом образе.

**Шаги:**

1. **Vercel Dashboard** → **Add New** → **Project**.
2. Импортируйте **тот же репозиторий** и ту же ветку.
3. При настройке:
   - **Root Directory**: `api` (если деплоите только API).
   - **Framework Preset**: Other / None.
   - **Build Command**: `npm run build` (выполнится в `api/` при Root = `api`).
   - **Output Directory**: для serverless API часто оставляют пустым или как подсказывает Vercel; критично, что entry — `index.js`.
   - **Node.js Version**: **20.x** (или 22.x).
4. **Deploy** без включения «restore cache» для первого деплоя.
5. После успешного деплоя можно удалить старый проект или переключить домен.

**Подводные камни:**

- Нужно заново прописать env vars и домены.
- Два проекта на один репо — не проблема, но не перепутайте, куда смотрите Production.

---

### 4. Понижение Fastify до 3.x

**Ожидаемый успех:** ~90%+ по устранению ошибки nft (но возможны регрессии по функционалу).

**Почему:** В Fastify 4.x в коде есть `??` (например, `lib/server.js`, plugin/utils). В 3.x их нет, nft перестаёт падать на этих файлах.

**Файл:** `api/package.json`.

**Шаги:**

1. Заменить `"fastify": "^4.28.1"` на `"fastify": "^3.29.0"` (последняя стабильная 3.x).
2. Проверить совместимость `@fastify/cors` с Fastify 3 (обычно есть версия под 3.x).
3. В папке `api/`: `rm -rf node_modules package-lock.json && npm install`.
4. Локально: `npm run build`, запуск, прогон сценариев (роуты, CORS, плагины).
5. Закоммитить изменения, задеплоить.

**Основные breaking changes при миграции 4 → 3 (на что смотреть):**

- **Типы TypeScript:** сигнатуры плагинов и декораторов в 4 более строгие; в 3 что-то может потребовать приведения типов или мелких правок.
- **Маршруты/хуки:** в 4 могли появиться мелкие изменения в порядке вызова или в API хуков — проверьте критические пути и middleware.
- **listen():** в 4 опции `listen()` могли расшириться; в 3 те же опции обычно работают.
- **Плагины:** если используете кастомные плагины под 4.x, проверьте совместимость с 3.x в их README/changelog.

Официально: [Fastify Migration Guide v4](https://fastify.dev/docs/latest/Guides/Migration-Guide-V4/) — смотрите в обратную сторону (что теряется при переходе с 4 на 3).

**Подводные камни:**

- Долгосрочно 3.x будет получать только security-фиксы; новый функционал — в 4.x. Оцените, готовы ли зафиксироваться на 3.x.

---

### 5. patch-package / postinstall: замена ?? в node_modules

**Ожидаемый успех:** ~85–95% по обходу ошибки nft; риск поломки при обновлении Fastify.

**Почему:** После `npm install` вы физически меняете код в `node_modules/fastify`, чтобы в файлах не оставалось `??`. nft тогда видит только «старый» синтаксис.

**Вариант A: patch-package (рекомендуется в 2026)**

1. В `api/`: `npm i -D patch-package`.
2. В `api/package.json` в `scripts` добавить: `"postinstall": "patch-package"`.
3. Вручную отредактировать `node_modules/fastify/lib/server.js`: заменить нужные вхождения `??` на `||` (например, `listenOptions.port ?? 0` → `listenOptions.port || 0`). Сохранить.
4. Выполнить: `npx patch-package fastify`. В `patches/` появится файл вида `fastify+4.x.x.patch`.
5. Закоммитить папку `patches/` и изменения в `package.json`. На Vercel при каждом `npm install` будет применяться патч.

**Вариант B: postinstall-скрипт (простая замена через sed/Node)**

1. Создать скрипт, например `api/scripts/patch-fastify-nullish.cjs`, который читает `node_modules/fastify/lib/server.js`, делает замену строки с `??` на `||`, и записывает файл обратно.
2. В `api/package.json`: `"postinstall": "node scripts/patch-fastify-nullish.cjs"`.
3. Убедиться, что на Vercel выполняется `npm install` или `npm ci` (postinstall вызывается после установки зависимостей).

**Работает ли это в 2026 на Vercel:** да. Postinstall выполняется в build phase; патч применяется до того, как nft трассирует файлы. Важно: скрипт не должен падать при отсутствии файла (например, при смене версии Fastify) — иначе билд сломается.

**Подводные камни:**

- При обновлении Fastify патч может не применяться (изменились номера строк) или конфликтовать. Нужно пересоздавать патч или править скрипт.
- Жёсткая замена по строке может зацепить комментарий или строковый литерал; делайте замену аккуратно (например, только ` ?? ` → ` || `).

---

## Где выставлять Node.js в 2026 (General vs Build vs Root)

- **Settings → General → Node.js Version**  
  Главное место. Задаёт версию Node и для сборки, и для рантайма serverless-функций в большинстве конфигураций. В 2026 приоритет у этого поля.

- **Settings → Build & Development Settings**  
  Здесь иногда дублируется выбор Node (зависит от интерфейса). Если есть отдельное поле Node — выставить ту же 20.x. Сюда же относятся Root Directory, Install Command, Build Command: они определяют **где** и **как** идёт билд, но не обязательно меняют образ Node сами по себе — образ чаще задаётся General.

- **Root Directory**  
  Не задаёт версию Node, но критичен для монорепо: при Root = `api` все команды и путь к `vercel.json` считаются от `api/`. Неверный Root приводит к билду не из той папки и к игнорированию `api/vercel.json` или `api/package.json` engines.

**Итог:** Сначала выставить **Node 20.x** в **General**, проверить **Root Directory**, при необходимости продублировать Node в Build & Development Settings, затем сделать **Clear cache and redeploy**.

---

## Как заставить Vercel использовать свежий @vercel/nft

- **Runtime Node 20/22:** через General и/или `vercel.json` → `functions[].runtime`. Актуальный рантайм обычно идёт в паре с актуальным build image и обновлённым nft.
- **Clear build cache and redeploy:** старый артефакт трассировки и кэш зависимостей сбрасываются, билд заново тянет зависимости и заново запускает nft.
- **Новый проект:** тот же репо, новая настройка — без наследования кэша и старых настроек образа.

Отдельно «обновить только nft» в интерфейсе Vercel нельзя — он часть билд-пайплайна. Фактически обновление идёт через новый образ (Node 20/22) и чистый кэш.

---

## Fastify 4 → 3: стоит ли понижать

**Стоит, если:** нужно быстро убрать ошибку nft и вы не используете фичи, появившиеся только в 4.x (новые хуки, изменения в типах, в API плагинов).

**Не стоит, если:** проект уже завязан на 4.x API или плагины только под 4. Тогда надёжнее Node 20 + cache clear + явный runtime; при необходимости — patch-package.

**Основные breaking при переходе 4 → 3:** см. выше (типы, listen, плагины). Полный список — в официальном Migration Guide v4, читать в обратную сторону.

---

## Обновлённый vercel.json под Fastify + Node 20/22

Файл: **`api/vercel.json`** (в корне папки API).

```json
{
  "version": 2,
  "rewrites": [{ "source": "/(.*)", "destination": "/index.js" }],
  "functions": {
    "index.js": {
      "runtime": "nodejs20.x",
      "maxDuration": 30
    }
  }
}
```

- **`runtime`:** в 2026 надёжно фиксировать `nodejs20.x` или `nodejs22.x` (если доступен в вашем аккаунте). Так трассировка и рантайм идут на выбранной версии Node.
- **`maxDuration`:** по желанию (лимит выполнения функции в секундах). Для API часто 10–30.
- Ключ **`index.js`** должен соответствовать пути к точке входа. Если Root Directory = `api`, то entry — `index.js`; если Root = корень репо и entry в подпапке — может быть `api/index.js` (проверьте в логах билда, какой файл используется как function).

Для Node 22 замените на `"runtime": "nodejs22.x"` (если есть в списке рантаймов).

---

## Короткий чек-лист (5–10 минут, высокая вероятность решения)

1. **Vercel → проект → Settings → General** → **Node.js Version** = **20.x** (или 22.x). Сохранить.
2. **Settings → General** → **Root Directory** = `api` (если деплой только из папки api). Сохранить.
3. **Deployments** → последний деплой → **⋯** → **Redeploy** → включить **Clear build cache and redeploy** → **Redeploy**.
4. В репо в **`api/vercel.json`** убедиться, что есть `"functions": { "index.js": { "runtime": "nodejs20.x" } }` (путь к entry при необходимости поправить). Закоммитить, запушить.
5. В **`api/package.json`** проверить наличие `"engines": { "node": ">=20" }`. Закоммитить при изменении, пушить.
6. После деплоя открыть **Build Logs** и убедиться, что в логах видна Node 20 (или 22) и билд идёт из нужной директории.
7. Если ошибка та же — создать **новый проект** Vercel на том же репо, Root = `api`, Node = 20.x, один деплой без кэша; при успехе перенести env/домены и при необходимости удалить старый проект.

---

## Если ошибка остаётся

1. **Проверить точный путь к функции:** в Build Logs посмотреть, какой файл Vercel считает serverless-функцией. Убедиться, что ключ в `functions` в `vercel.json` совпадает с этим путём.
2. **Понизить Fastify до 3.x** (см. решение 4) или внедрить **patch-package** для Fastify (решение 5).
3. **Vercel Support:** в дашборде Help → Contact / support. Приложить: сообщение об ошибке, фрагмент Build Logs, что уже сделано (Node 20, cache clear, vercel.json, монорепо/root directory).
4. **GitHub:** [vercel/vercel](https://github.com/vercel/vercel) — поиск по "BinaryExpression" / "nft" / "nullish"; при отсутствии подходящего issue создать новый с тегом node, serverless, nft.
5. **Обходной путь:** развернуть API не как Vercel Serverless, а как **Node server** на другой платформе (Railway, Render, Fly.io, собственный VPS) и с Vercel оставить только фронт/статику; для Fastify это часто проще, чем бороться с nft.

---

## Кратко

В феврале 2026 в большинстве случаев достаточно: **Node 20.x в General** + **Root Directory = api** (для монорепо) + **Clear cache and redeploy** + **явный `runtime` в `api/vercel.json`**. Если не помогло — новый проект без кэша, затем понижение Fastify до 3.x или patch-package для 4.x.
