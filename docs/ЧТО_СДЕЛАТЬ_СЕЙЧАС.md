# Что сделать сейчас, чтобы всё заработало

Краткий чек-лист после настройки репо и Vercel.

---

## 1. Проект WebApp на Vercel

В **Settings → Environment Variables** проекта, где деплоится Mini App (например **taxi-bot-rouge**):

| Переменная       | Значение                         | Environment   |
|------------------|----------------------------------|---------------|
| `VITE_API_URL`   | `https://taxi-botapi.vercel.app` | Production (и Preview при необходимости) |

- **Без слэша в конце.**
- После изменения переменной сделайте **Redeploy** (Deployments → … → Redeploy), иначе старая сборка будет без нового URL.

---

## 2. Проект API на Vercel

В **Settings → Environment Variables** проекта API (например **taxi-botapi**):

| Переменная      | Описание |
|-----------------|----------|
| `DATABASE_URL`  | Pooled-строка Neon (с `-pooler` в хосте) |
| `DIRECT_URL`    | Direct-строка Neon |
| `BOT_TOKEN`     | Токен от @BotFather |
| `WEBAPP_URL`    | URL Mini App **со слэшем**, например `https://taxi-bot-rouge.vercel.app/` |
| `API_SECRET`    | Секрет (тот же, что у бота в `API_SECRET`) |

Опционально: `WEBAPP_ORIGIN=https://taxi-bot-rouge.vercel.app` — ограничить CORS только этим origin.

После изменений — **Redeploy** API.

---

## 3. Бот (Telegram)

Бот должен знать URL API и WebApp. В `.env` у бота (или в переменных на Railway/сервере):

- `API_URL=https://taxi-botapi.vercel.app`
- `WEBAPP_URL=https://taxi-bot-rouge.vercel.app/`
- `API_SECRET` — тот же, что в API.

Перезапустите бота после смены переменных.

---

## 4. Убрать лишний проект taxi-bot-api-v2 (по желанию)

Если в Vercel есть проект **taxi-bot-api-v2** и он падает при деплое — он не используется. Удалите его (Settings → Delete Project) или отвяжите репо, чтобы не получать письма об ошибках. Подробнее: [VERCEL_PROJECTS.md](VERCEL_PROJECTS.md).

---

## 5. Проверка

1. **Ping:** откройте в браузере  
   `https://taxi-botapi.vercel.app/ping`  
   Должно вернуться что-то вроде: `{"ok":true,"origin":null,"url":"/ping","t":...}`.

2. **Mini App в Telegram:** откройте бота → команда/кнопка, которая открывает Mini App.  
   - Если видите «Нет связи» или вечную загрузку — откройте Mini App в браузере (ПК) через «Открыть в…» и в DevTools (F12) → вкладка **Network** посмотрите, какой запрос красный (OPTIONS или GET `/api/agents/me`), какой статус и ответ.  
   - Убедитесь, что в проекте WebApp на Vercel задан `VITE_API_URL` и сделан Redeploy после его добавления.

3. **Менеджер:** кабинет менеджера открывайте **из Telegram** (чтобы был валидный `initData`), иначе API вернёт 401.

---

## Итого

| Где              | Что проверить |
|------------------|----------------|
| Vercel WebApp    | `VITE_API_URL` = URL API без слэша, Redeploy |
| Vercel API       | DATABASE_URL, BOT_TOKEN, WEBAPP_URL, API_SECRET, Redeploy |
| Бот              | API_URL, WEBAPP_URL, API_SECRET, перезапуск |
| Vercel (опц.)    | Удалить taxi-bot-api-v2, если мешает |

После этого запросы из Mini App должны доходить до API, а бот — открывать правильный WebApp и ходить в тот же API.
