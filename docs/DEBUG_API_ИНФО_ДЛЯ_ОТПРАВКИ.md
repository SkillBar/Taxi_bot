# Что происходит и какая инфо нужна (для отправки в поддержку / другу)

## Что видит пользователь

При открытии Mini App в Telegram:

1. Вверху шапка «Агенты Такси» и полоска «Кабинет агента такси».
2. Ниже — сообщение **«Не удалось загрузить интерфейс.»** и кнопка **«Открыть кабинет»** (упрощённый режим).

То есть основной интерфейс (онбординг или кабинет с списком) не показывается, срабатывает fallback.

---

## Что делает приложение при загрузке (по шагам)

1. **Инициализация в браузере**  
   - Подключается скрипт Telegram Web App и наш код.  
   - Вызываются `init()` SDK и монтаж темы (themeParams), затем рендер React.

2. **Первый запрос к API**  
   - Сразу при открытии уходит запрос:
   - **GET** `{BASE_URL}/api/agents/me`
   - Заголовок: **`X-Telegram-Init-Data`** (или **`x-telegram-init-data`**) — строка initData от Telegram (подпись, user, auth_date и т.д.).

3. **Ответ `/api/agents/me`**  
   - Успех (200): `{ telegramUserId, firstName, lastName, linked }`.  
   - По нему решаем: показывать онбординг или кабинет.  
   - Ошибка (4xx/5xx): фронт переходит на экран онбординга и потом при рендере может упасть в «Не удалось загрузить интерфейс».

4. **Второй запрос (если `linked === true`)**  
   - **GET** `{BASE_URL}/api/manager/me`  
   - Тот же заголовок **`x-telegram-init-data`**.  
   - Успех (200): `{ hasFleet }` — показываем кабинет или онбординг (подключить Fleet).  
   - Ошибка: теперь обрабатывается на фронте (переход на онбординг), раньше могла быть необработанная ошибка.

5. **Почему показывается «Не удалось загрузить интерфейс»**  
   - Либо при рендере экрана (онбординг/кабинет) падает код (например, UI-библиотека telegram-ui).  
   - Либо до этого что-то пошло не так с API (401/500/сеть), и после перехода на онбординг этот экран при отрисовке падает и ловится нашим Error Boundary.

То есть проблема может быть и в API (первый/второй запрос), и в рендере после ответа API.

---

## Что проверить на стороне API

1. **Доступность и URL**  
   - Какой именно `BASE_URL` у Mini App в проде (переменная `VITE_API_URL` при сборке).  
   - Открывается ли в браузере без 404/CORS:  
     `https://<API_DOMAIN>/api/agents/me`  
     (без заголовка будет 401 — это ожидаемо).

2. **401 от `/api/agents/me` или `/api/manager/me`**  
   - Обычно значит: нет заголовка `x-telegram-init-data` или он невалидный.  
   - API проверяет подпись через **BOT_TOKEN** (тот же, что у бота, из которого открыт Mini App).  
   - Нужно: тот же `BOT_TOKEN` в окружении API и корректный initData от Telegram (не поддельный, не от другого бота).

3. **Логи на API**  
   - Есть ли запросы на `GET /api/agents/me` и `GET /api/manager/me` при открытии Mini App.  
   - Какой статус возвращается (200, 401, 500) и тело ответа при ошибке.

4. **CORS**  
   - Домен Mini App (например, `https://<webapp>.vercel.app`) должен быть разрешён в CORS на API.  
   - Иначе в браузере будет ошибка сети при запросе к API.

---

## Какую инфу прислать (чтобы быстрее найти причину)

Скопируй и отправь вместе с описанием:

1. **Где открыт Mini App**  
   - Из какого бота (username), с телефона или с десктопа.

2. **Что в Network (вкладка Сеть)**  
   - Открыть Mini App в Telegram, затем (если есть возможность) DevTools → вкладка Network.  
   - Найти запрос к твоему API (например, `me` или `agents/me`).  
   - Прислать:  
     - URL запроса (полностью),  
     - метод (GET),  
     - статус ответа (200, 401, 500 и т.д.),  
     - если 4xx/5xx — тело ответа (текст или JSON).

3. **Окружение API**  
   - Подставлен ли в API тот же **BOT_TOKEN**, что у бота, из которого открывается Mini App.  
   - Какой домен у API в проде (тот же ли, что в `VITE_API_URL` у собранного webapp).

4. **Консоль браузера**  
   - Если Mini App можно открыть в веб-клиенте Telegram или в десктопе с DevTools — скопировать сюда текст ошибок из консоли (красные сообщения) в момент загрузки и при нажатии «Открыть кабинет» (если что-то есть).

Этого достаточно, чтобы понять, упираемся ли в API (401/500/CORS/сеть) или в падение интерфейса уже после ответа API.
