# Проблема: список исполнителей (водителей) не показывается

## Формулировка

В мини-приложении «Кабинет агента такси» на экране «Исполнители» список водителей пустой: отображается «Исполнители не найдены», хотя в парке Яндекс.Такси (Fleet) по данному API-ключу водители есть. Нужно понять причину и добиться отображения списка водителей парка.

## Что есть в системе

- **Фронт (webapp):** запрос `GET /api/manager/drivers` при открытии главной. Ожидается ответ `{ drivers: [...], meta?: { source, count, hint } }`. При пустом списке показывается блок «В чём причина» с текстом из `meta.hint` или подсказкой по источнику.
- **Бэкенд (api):** маршрут `GET /api/manager/drivers`:
  - Определяет менеджера по `x-telegram-init-data` (telegram user id).
  - Если у менеджера есть учётные данные Fleet (apiKey, parkId, clientId) — запрос к **Yandex Fleet API**: `POST https://fleet-api.taxi.yandex.net/v1/parks/driver-profiles/list` с телом `{ query: { park: { id: parkId } }, fields: { driver_profile: [...], account: [...] }, limit: 500, offset: 0 }`, заголовки `X-Client-ID`, `X-API-Key`, `X-Park-Id`.
  - Ответ Fleet разбирается так: список водителей ищем в `data.driver_profiles`, или в `data.parks[].driver_profiles`, или в `data.parks` как объект по ключам парков.
  - Если учётных данных Fleet нет — возвращаются только привязки по телефону из БД (DriverLink), обычно пусто.
- **Онбординг:** пользователь вводит API-ключ и (при необходимости) ID парка; вызывается `POST /api/manager/connect-fleet`, данные сохраняются в таблице Manager (yandexApiKey, yandexParkId, yandexClientId). После этого при запросе списка водителей должны подставляться эти учётные данные.
- **Логи на бэкенде (Vercel):** при запросе списка пишется `step: "drivers_list"`, `hasCreds`, `parkId` (префикс), при успехе Fleet — `source: "fleet"`, `parkDriversCount`; при пустом ответе Fleet — `fleetResponseTopLevelKeys` (ключи верхнего уровня ответа); при ошибке — `listParkDrivers_failed`, `message`.

## Возможные причины (для проверки)

1. **Парк не подключён:** у менеджера в БД нет `yandexApiKey` / `yandexParkId` (онбординг не завершён или другой пользователь). В логах: `hasCreds: false`, в ответе `meta.source: "driver_link"`, `meta.hint` про отсутствие подключения парка.
2. **Fleet возвращает пустой или другой формат:** запрос к Fleet успешен (200), но мы извлекаем 0 водителей. В логах: `parkDriversCount: 0`, при пустом ответе — `fleetResponseTopLevelKeys`. Нужно сверить структуру ответа Fleet с документацией (https://fleet.yandex.ru/docs/api/ru/) и при необходимости доработать разбор (другой ключ или вложенность).
3. **Ошибка Fleet (401/403/404/5xx):** неверный ключ, неверный park_id, нет прав. В логах: `listParkDrivers_failed`, `message` с текстом от Fleet. В ответе клиенту — 502, `code: "FLEET_DRIVERS_ERROR"`, в UI — текст ошибки.
4. **Несовпадение менеджера:** список запрашивается от имени другого telegram user id (другое устройство/аккаунт), у которого нет сохранённого Fleet. Проверить: один и тот же аккаунт в онбординге и при открытии списка.

## Что передать для диагностики

- Скрин экрана с блоком «В чём причина» (если после деплоя он показывается).
- Фрагменты логов Vercel по запросу `GET /api/manager/drivers`: строки с `drivers_list`, `hasCreds`, `source`, `parkDriversCount`, при наличии — `fleetResponseTopLevelKeys` или `listParkDrivers_failed` и `message`.
- Подтверждение: в кабинете fleet.yandex.ru для этого парка и API-ключа действительно есть водители и ключ имеет права на чтение списка водителей.

---

## Типичные причины «Исполнители не найдены» (Яндекс Таксометр / Яндекс Про)

Сообщение «Исполнители не найдены. Список водителей парка пуст или недоступен» + подсказка искать в логах `step=drivers_list`, `parkDriversCount` или `listParkDrivers_failed` характерно для интеграций с **Яндекс Таксометр / Яндекс Про** (Fleet API). Ниже — частые причины по убыванию вероятности.

### 1. В парке действительно нет водителей

Самая частая причина. Проверка: зайти в личный кабинет парка на **pro.yandex.ru** или **taximeter.yandex.ru** → раздел «Водители» / «Исполнители». Если список пуст — API возвращает пустой массив, приложение корректно показывает «не найдены».

### 2. Неправильный / устаревший / неактивный API-ключ

- Токен просрочен.
- Токен привязан к другому парку.
- Токен от физлица, а не от парка (у физлиц нет доступа к списку водителей).
- Недостаточные права (scope) у ключа.

В логах: `listParkDrivers_failed` и HTTP 403/401 или сообщение об ошибке авторизации.

### 3. Парк не привязан / не активирован

После регистрации парка может пройти 1–3 дня до полной активации. До этого API может возвращать 200 OK с пустым списком водителей.

### 4. Неправильный park_id в запросе

В настройках (онбординг) указан чужой, старый или тестовый парк — список будет пустой. Проверить: в кабинете Fleet какой ID парка, и совпадает ли он с сохранённым в приложении.

### 5. Проблемы на стороне Яндекса (редко)

Временные сбои, ограничения/модерация/блокировка парка, rate-limit при большом числе запросов (обычно отдельная ошибка/код).

### 6. Устаревший эндпоинт

Яндекс менял API (taximeter → pro → Fleet). Если интеграция написана под старый путь (например `/v1/parks/driver-list`), возможны пустой ответ или 404/403. В нашем боте используется актуальный Fleet API: `POST https://fleet-api.taxi.yandex.net/v1/parks/driver-profiles/list`.

---

## Что сделать по шагам

1. **Проверить кабинет парка** — есть ли хотя бы один водитель в разделе «Водители» / «Исполнители». Если нет — причина в пустом парке.
2. **Обновить API-токен** — скопировать свежий токен в кабинете (раздел «Интеграции» → API → создать/продлить), подставить в настройки приложения (онбординг/подключение парка), перезапустить/перезайти.
3. **Проверить логи бэкенда** по словам: `listParkDrivers_failed`, `step=drivers_list`, `parkDriversCount`, HTTP-код (200/401/403/429/500), текст ошибки от API (например `{"code": "access_denied", "message": "..."}`).
4. **Тестовый запрос к Fleet вручную** (curl) — убедиться, что ключ и park_id возвращают данные. Наш эндпоинт и заголовки:

```bash
curl -X POST "https://fleet-api.taxi.yandex.net/v1/parks/driver-profiles/list" \
  -H "X-Client-ID: ВАШ_CLIENT_ID" \
  -H "X-API-Key: ВАШ_API_КЛЮЧ" \
  -H "X-Park-Id: ВАШ_PARK_ID" \
  -H "Content-Type: application/json" \
  -d '{
    "query": { "park": { "id": "ВАШ_PARK_ID" } },
    "fields": {
      "driver_profile": ["id", "first_name", "last_name", "phones", "work_status"],
      "account": ["balance"]
    },
    "limit": 10,
    "offset": 0
  }'
```

- Пустой массив в ответе (или пустой `driver_profiles`) — в парке нет водителей или неверный park_id.
- Ошибка 401/403 — неверный ключ или права.
- Ошибка 404 — неверный park_id или эндпоинт.

Если приложить фрагмент лога с `step=drivers_list`, кодом ответа и текстом ошибки API — можно точнее указать, что проверить.

---

## Как понять: Яндекс отдаёт данные или нет

В ответе `GET /api/manager/drivers` при `meta.source === "fleet"` теперь есть поле **`meta.rawCount`** (если бэкенд его заполняет):

- **`rawCount === 0`** — Fleet API вернул пустой массив (или мы не нашли `driver_profiles` в ответе). Либо в парке нет водителей, либо неверный park_id/ключ, либо нестандартная структура ответа. Смотри в логах `fleetResponseTopLevelKeys`: если там есть `driver_profiles` — структура ок, просто пустой парк.
- **`rawCount > 0`, `count === 0`** — Fleet вернул N записей, но ни одна не прошла парсинг (формат элемента не совпадает). В логах будет `firstItemSample` — по нему можно поправить парсер.
- **`rawCount > 0`, `count > 0`** — данные от Яндекса пришли и отображаются. Если `count < rawCount` — часть записей отброшена (нет `id`, неверная структура); в логах есть `skippedCount`, `skippedNoId`.

Итог: по `rawCount` в ответе или в логах (`rawDriverProfilesLength`) сразу видно, **отдаёт ли Яндекс список** (пустой или нет) или проблема в нашем разборе/правах.
