# Ревизия кода (сеньор)

Дата: 2026-02. Полный обход API, webapp, конфиг, безопасность.

---

## Исправлено в этой ревизии

### 1. **Безопасность: PATCH /api/agents/:agentId/email**
- **Было:** Эндпоинт без авторизации — любой мог изменить email любого агента, зная `agentId`.
- **Стало:** Добавлен `preHandler: authFromInitData`, проверка `agent.telegramUserId === telegramUserId`; при несовпадении — 403.

### 2. **Безопасность: replay initData**
- **Было:** Проверялась только подпись HMAC, срок давности `auth_date` не проверялся — старый initData можно было переиспользовать.
- **Стало:** В `validateInitData(initData, botToken, maxAgeSec)` добавлен опциональный параметр `maxAgeSec`; во всех маршрутах передаётся `86400` (24 ч). initData старше 24 часов отклоняется.

---

## Рекомендации (не критично)

### API

- **config.ts:** `config.botToken` и `config.databaseUrl` с `!` — при отсутствии env в рантайме возможны неочевидные ошибки (например, `validateInitData` с `undefined` token). Рекомендация: при старте приложения проверять обязательные переменные и логировать/падать явно.
- **db.ts:** Один глобальный `PrismaClient()`. Для serverless (Vercel) иногда рекомендуют не создавать клиент на уровне модуля, чтобы избежать исчерпания соединений при холодном старте. Текущая схема допустима при использовании connection pool (Neon); при росте нагрузки — мониторить.
- **agent.ts:** `normalizePhone` для номеров без 7/8/9 в начале может вернуть "+" + digits (например, 10 цифр с ведущим 9 → "+79..."). Убедиться, что все входящие форматы покрыты тестами или документацией.
- **yandex-fleet.ts:** При вызове из маршрутов используется только `Manager`-creds; глобальные `config.yandex*` (функция `headers()`) используются только если где-то есть код, работающий без менеджера. Проверить, что мёртвого кода нет, или вынести в отдельный путь.

### Webapp

- **OnboardingScreen:** `DEFAULT_PARK_ID` и `DEFAULT_CLIENT_ID` захардкожены — все пользователи подключают один и тот же парк. Если нужны разные парки на одного инстанс, вынести в env (например, при сборке) или запрашивать у пользователя.
- **App.tsx:** При переходе на `initError` и нажатии «Повторить» счётчик `retryCount` увеличивается и эффект перезапускается — корректно. Убедиться, что при быстром двойном клике не создаётся две параллельные цепочки запросов (при необходимости debounce).

### Деплой и конфиг

- **dotenv в app.ts:** Путь `path.resolve(__dirname, "../../.env")` при сборке в `_dist` указывает на корень репо. На Vercel (Root Directory = api) файла `../../.env` нет — используются переменные из настроек проекта. Ок.
- **CORS:** Сейчас разрешён любой origin. Для продакшена можно задать `WEBAPP_ORIGIN` (один или несколько через запятую) и ужесточить проверку в `app.ts` (сейчас при заданном `WEBAPP_ORIGIN` мы всё равно в конце разрешаем любой — можно убрать fallback `return cb(null, true)` при `allowed.length > 0` и не совпадающем origin).

---

## Чек-лист перед продакшеном

- [ ] В Vercel (API): заданы `DATABASE_URL`, `DIRECT_URL`, `BOT_TOKEN`, `API_SECRET`, `WEBAPP_URL`.
- [ ] В Vercel (WebApp): задан `VITE_API_URL` = URL API, после изменений — Redeploy.
- [ ] В Bot: `API_URL`, `WEBAPP_URL`, `API_SECRET`, `BOT_TOKEN` совпадают с API и BotFather.
- [ ] При необходимости ограничить CORS: задать `WEBAPP_ORIGIN` в API и ужесточить логику в `app.ts`.
- [ ] Проверка обязательных env при старте API (опционально, но упрощает отладку).
